<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Refer & Earn</title>
  <style>
    body { font-family: sans-serif; background: #111; padding: 20px; color: #fff; }
    select, input, button, .link-box { width:100%; padding:10px; margin:10px 0; border:none; border-radius:6px; }
    button { background:#2ecc71; color:#fff; cursor:pointer; }
    .link-box { background:#222; }
  </style>
</head>
<body>
  <h2>ðŸ”— Create Your Referral Link</h2>

  <label for="offer">Select Offer</label>
  <select id="offer">
    <option value="">-- Choose an offer --</option>
  </select>

  <label for="upi">Enter Your UPI ID</label>
  <input type="text" id="upi" placeholder="example@upi" />

  <button onclick="createReferLink()">Create Refer Link</button>

  <div id="output" class="link-box" style="display:none;">
    <strong>Your Link:</strong>
    <p id="ref-link"></p>
    <button onclick="copyLink()">Copy</button>
  </div>

  <script type="module">
    const offerSelect = document.getElementById("offer");
    let offersList = [];

    async function loadOffers() {
      try {
        const res = await fetch("https://groww-social.github.io/camps/offers.json");
        const offers = await res.json();
        offersList = offers;

        offers.forEach((offer, idx) => {
          const option = document.createElement("option");
          option.value = idx;
          option.textContent = ${offer.offer} (â‚¹${offer.refer});
          offerSelect.appendChild(option);
        });
      } catch (err) {
        alert("âš  Failed to load offers. Please check offers.json file.");
        console.error(err);
      }
    }

    async function getToken() {
      const tokenModule = await import("https://campjs.netlify.app/apis.js");
      return tokenModule.default;
    }

    async function loadRefers(token) {
      const res = await fetch("https://api.github.com/repos/groww-social/camps/contents/refers.json", {
        headers: { Authorization: Bearer ${token} }
      });
      const json = await res.json();
      const content = atob(json.content);
      return { refers: JSON.parse(content), sha: json.sha };
    }

    async function saveRefers(refers, sha, token) {
      const content = btoa(JSON.stringify(refers, null, 2));
      await fetch("https://api.github.com/repos/groww-social/camps/contents/refers.json", {
        method: "PUT",
        headers: {
          Authorization: Bearer ${token},
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          message: "Add new refer",
          content: content,
          sha: sha
        })
      });
    }

    async function createReferLink() {
      const offerIndex = offerSelect.value;
      const upi = document.getElementById("upi").value.trim();

      if (offerIndex === "") return alert("Please select an offer.");
      if (!upi || !upi.includes("@")) return alert("Enter a valid UPI ID.");

      const selectedOffer = offersList[offerIndex];
      const offerId = selectedOffer.id;

      const token = await getToken();
      const { refers, sha } = await loadRefers(token);
      const newId = refers.length + 1;

      const link = https://groww-social.github.io/camps/?id=${offerId}&ref=${newId};
      document.getElementById("ref-link").textContent = link;
      document.getElementById("output").style.display = "block";

      refers.push({ upi, id: newId.toString() });
      saveRefers(refers, sha, token);
    }

    function copyLink() {
      const text = document.getElementById("ref-link").textContent;
      navigator.clipboard.writeText(text);
      alert("Link copied!");
    }

    loadOffers();
  </script>
</body>
</html>
