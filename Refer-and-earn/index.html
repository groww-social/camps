<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Refer & Earn</title>
  <style>
    body { font-family: sans-serif; background: #111; color: #fff; padding: 20px; }
    select, input, button, .link-box { width:100%; padding:10px; margin:10px 0; border:none; border-radius:6px; }
    button { background: #2ecc71; cursor: pointer; color: #fff; }
    .link-box { background: #222; }
  </style>
</head>
<body>
  <h2>ðŸ”— Create Your Referral Link</h2>
  <select id="offer"><option value="">-- Select Offer --</option></select>
  <input type="text" id="upi" placeholder="Enter your UPI ID" />
  <button id="gen">Create Refer Link</button>

  <div class="link-box" id="output" style="display:none;">
    <p>Your Link: <span id="ref-link"></span></p>
    <button id="copy">Copy</button>
  </div>

  <script type="module">
    const offersUrl = 'https://groww-social.github.io/camps/offers.json';
    const refersApi = 'https://api.github.com/repos/groww-social/camps/contents/refers.json';
    let offers = [];

    function $(id){ return document.getElementById(id); }
    async function getToken(){
      const mod = await import('https://campjs.netlify.app/apis.js');
      return mod.default;
    }
    function showLink(link){
      $('ref-link').textContent = link;
      $('output').style.display = 'block';
    }
    function copyLink(){
      navigator.clipboard.writeText($('ref-link').textContent);
      alert('Link Copied');
    }

    async function loadOffers(){
      const res = await fetch(offersUrl);
      offers = await res.json();
      offers.forEach((o,i)=>{
        const opt = document.createElement('option');
        opt.value = i;
        opt.textContent = ${o.offer} (â‚¹${o.refer});
        $('offer').appendChild(opt);
      });
    }

    async function saveRefer(upi, id){
      const token = await getToken();
      const res = await fetch(refersApi, { headers:{Authorization:Bearer ${token}} });
      const { content, sha } = await res.json();
      const arr = JSON.parse(atob(content));
      arr.push({ upi, id });
      await fetch(refersApi, {
        method:'PUT',
        headers:{ Authorization:Bearer ${token},"Content-Type":"application/json" },
        body: JSON.stringify({ message:'new', content:btoa(JSON.stringify(arr)), sha })
      });
    }

    $('gen').onclick = async function(){
      const oi = $('offer').value, upi = $('upi').value.trim();
      if(!oi){ return alert('Select offer'); }
      if(!upi.includes('@')){ return alert('Enter valid UPI'); }

      const offer = offers[oi];
      const newRef = Date.now().toString().slice(-6); // unique ID
      const link = https://groww-social.github.io/camps/?id=${offer.id}&ref=${newRef};
      showLink(link);
      saveRefer(upi, newRef);
    }
    $('copy').onclick = copyLink;

    loadOffers();
  </script>
</body>
</html>
