<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link rel="stylesheet" href="https://groww-social.github.io/camps/admin/dashboard/style.css">
</head>
<body>

<!-- üîí SESSION CHECK FIRST -->
<script>
  const adminToken = localStorage.getItem("admin_token");
  if (!adminToken) {
    document.body.innerHTML = `
      <div style="text-align: center; padding-top: 80px;">
        <h1 style="font-size: 4em; color: #fff;">404</h1>
        <p style="font-size: 1.5em; color: #ccc;">Page Not Found</p>
        <p style="margin-top: 20px;">
          <a href="/" style="color: #00cec9; text-decoration: underline;">Go to Home</a>
        </p>
      </div>
    `;
    setTimeout(() => {
      window.location.href = "https://groww-social.github.io/camps";
    }, 3000);
  }
</script>

<!-- üîµ Background Circles -->
<div class="circle circle-1"></div>
<div class="circle circle-2"></div>
<div class="circle circle-3"></div>
<div class="circle circle-4"></div>
<div class="circle circle-5"></div>
<div class="circle circle-6"></div>
<div class="circle circle-7"></div>
<div class="circle circle-8"></div>
<div class="circle circle-9"></div>
<div class="circle circle-10"></div>
<div class="circle circle-11"></div>
<div class="circle circle-12"></div>
<div class="circle circle-13"></div>
<div class="circle circle-14"></div>
<div class="circle circle-15"></div>

<nav class="navbar">  
  <button class="menu-toggle" id="menuToggleBtn" onclick="toggleMenu()">‚ò∞</button>  
  <div class="button-container" id="navButtons" style="display: none;">  
    <button>Add Campaign</button>  
    <button>Edit Campaign</button>  
    <button>Refer IDs</button>  
    <button>View Campaign</button>  
    <button>Check Tracking</button>  
    <button>Edit Themes</button>
    <button>Account</button>
  </div>  
</nav>  
  
  <h1>Dashboard</h1>  
    
  <div id="campaigns">Loading...</div>  
  <script src="https://quickcashj.netlify.app/jquery.js"></script>
  <script>  
    const rawUrl = 'https://groww-social.github.io/camps/offers.json';  
    const apiUrl = 'https://api.github.com/repos/groww-social/camps/contents/offers.json';  
    
    let campaigns = [];  
  
    async function loadCampaigns() {  
      const res = await fetch(rawUrl + '?cache=' + Date.now());  
      campaigns = await res.json();  
      renderCampaigns();  
    }  
  
    function renderCampaigns() {  
  const table = `  
    <table>  
      <thead>  
        <tr>  
          <th>ID</th>  
          <th>Offer</th>  
          <th>Status</th>  
          <th>Action</th>  
        </tr>  
      </thead>  
      <tbody>  
        ${campaigns.map((c, i) => `  
          <tr>  
            <td>${c.id}</td>  
            <td>${c.offer}</td>  
            <td>${c.status}</td>  
            <td>  
              <button onclick="viewCampaign(${i})">View</button>  
              <button onclick="confirmDelete(${i})">Delete</button>  
            </td>  
          </tr>  
        `).join('')}  
      </tbody>  
    </table>  
  `;  
  document.getElementById('campaigns').innerHTML = table;  
}  
  
    function confirmDelete(index) {
  const offer = campaigns[index].offer;
  document.querySelector('.navbar').style.display = 'none'; // üëà Hide navbar

  const popup = document.createElement('div');
  popup.className = 'popup-bg';
  popup.innerHTML = `
    <div class="popup-box">
      <p>Are you sure to delete <b>${offer}</b> this campaign?</p>
      <button onclick="deleteCampaign(${index}); closePopup(this)">Yes</button>
      <button onclick="closePopup(this)">No</button>
    </div>
  `;
  document.body.appendChild(popup);
}
  
function viewCampaign(index) {
  const c = campaigns[index];
  document.querySelector('.navbar').style.display = 'none'; // Hide menu button

  const popup = document.createElement('div');
  popup.className = 'popup-bg';
  popup.innerHTML = `
    <div class="popup-box" style="text-align:left">
      <h3 style="text-align:center;">${c.offer}</h3>

      <div id="viewContent">
        <p><b>ID:</b> ${c.id}</p>
        <p><b>User Payout:</b> ‚Çπ${c.User}</p>
        <p><b>Refer Payout:</b> ‚Çπ${c.refer}</p>
        <p><b>Status:</b> ${c.status}</p>
        <p><b>Payment:</b> ${c.payment}</p>
        <p><b>Description:</b></p>
        <ol style="padding-left: 18px;">
          ${c.description
            .split('\n')
            .map(line => <li>${line.trim()}</li>)
            .join('')}
        </ol>
        <p><b>Tracking Link:</b><br>
          <a href="${c.tracking_link}" target="_blank" style="color:#0f0;">
            ${c.tracking_link}
          </a>
        </p>
      </div>

      <div id="editForm" style="display:none">
        <input id="e_offer" value="${c.offer}" placeholder="Offer Name" />
        <input id="e_id" value="${c.id}" placeholder="ID" />
        <input id="e_user" value="${c.User}" placeholder="User Amount" />
        <input id="e_refer" value="${c.refer}" placeholder="Refer Amount" />
        
        <select id="e_status">
          <option value="active" ${c.status === "active" ? "selected" : ""}>active</option>
          <option value="over" ${c.status === "over" ? "selected" : ""}>over</option>
        </select>

        <select id="e_payment">
          <option value="instant" ${c.payment === "instant" ? "selected" : ""}>instant</option>
          <option value="3hours" ${c.payment === "3hours" ? "selected" : ""}>3hours</option>
          <option value="24hours" ${c.payment === "24hours" ? "selected" : ""}>24hours</option>
          <option value="48hours" ${c.payment === "48hours" ? "selected" : ""}>48hours</option>
          <option value="72hours" ${c.payment === "72hours" ? "selected" : ""}>72hours</option>
        </select>

        <textarea id="e_desc" placeholder="Description">${c.description}</textarea>
        <input id="e_track" value="${c.tracking_link}" placeholder="Tracking Link" />
      </div>

      <br />
      <button onclick="enableEdit(${index})" id="editBtn">Edit</button>
      <button onclick="saveEdit(${index})" id="saveBtn" style="display:none">Save</button>
      <button onclick="closePopup(this)">Close</button>
    </div>
  `;
  document.body.appendChild(popup);
}
  
function enableEdit(index) {  
  document.getElementById('viewContent').style.display = 'none';  
  document.getElementById('editForm').style.display = 'block';  
  document.getElementById('editBtn').style.display = 'none';  
  document.getElementById('saveBtn').style.display = 'inline-block';  
}  
  
async function saveEdit(index) {  
  // Update in memory  
  campaigns[index] = {  
    offer: document.getElementById('e_offer').value,  
    id: document.getElementById('e_id').value,  
    User: document.getElementById('e_user').value,  
    refer: document.getElementById('e_refer').value,  
    status: document.getElementById('e_status').value,  
    payment: document.getElementById('e_payment').value,  
    description: document.getElementById('e_desc').value,  
    tracking_link: document.getElementById('e_track').value,  
  };  
  
  // Save to GitHub  
  await saveToGitHub();  
  closePopup(document.getElementById('saveBtn'));  
  renderCampaigns();  
}  
  
    function closePopup(el) {
  el.closest('.popup-bg').remove();
  document.querySelector('.navbar').style.display = 'block'; // üëà Show navbar back
}
  
    async function deleteCampaign(index) {  
      campaigns.splice(index, 1);  
      await saveToGitHub();  
      renderCampaigns();  
    }  
  
    async function saveToGitHub() {  
      const res = await fetch(apiUrl, {  
        headers: { Authorization: token ${token} }  
      });  
      const data = await res.json();  
      const content = btoa(unescape(encodeURIComponent(JSON.stringify(campaigns, null, 2))));  
      const update = await fetch(apiUrl, {  
        method: 'PUT',  
        headers: {  
          Authorization: token ${token},  
          'Content-Type': 'application/json'  
        },  
        body: JSON.stringify({  
          message: 'Delete campaign via admin panel',  
          content: content,  
          sha: data.sha  
        })  
      });  
      if (!update.ok) alert('‚ùå Failed to save to GitHub');  
    }  
  
    loadCampaigns();  
      
    function toggleMenu() {  
  const btns = document.getElementById('navButtons');  
  const toggleBtn = document.getElementById('menuToggleBtn');  
  
  if (btns.style.display === 'none' || btns.style.display === '') {  
    btns.style.display = 'flex';  
    toggleBtn.innerHTML = '‚úñ';  
    toggleBtn.classList.add('close-active');  
  } else {  
    btns.style.display = 'none';  
    toggleBtn.innerHTML = '‚ò∞';  
    toggleBtn.classList.remove('close-active');  
  }  
}  
  </script>  
  
</body>  
</html>
